<!DOCTYPE html>
<html lang="en">
  <script>
    // ===================================================
    // ENHANCED ACCESS CONTROL FOR RESTRICTED POSITIONS
    // ===================================================
    const hrOnlyPages = [
        "dashboard.html", "employee.html", "employee_add.html", 
        "employee_edit.html", "employee_view.html", "payroll.html", "reports.html", 
        "leaverequest.html", "in&out.html"
    ];

    const currentPage = window.location.pathname.split("/").pop();
    const loggedInUserString = localStorage.getItem('loggedInUser');

    if (!loggedInUserString) {
        window.location.href = "index.html";
    } else {
        const loggedInUser = JSON.parse(loggedInUserString);
        const userRole = loggedInUser.role;
        const userPosition = loggedInUser.position || '';
        
        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        if (isRestricted && hrOnlyPages.includes(currentPage)) {
            window.location.href = "attendance.html";
        }
        
        if (userRole === "Employee" && hrOnlyPages.includes(currentPage)) {
            window.location.href = "attendance.html";
        }
    }
  </script>

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Tracking</title>
    <link rel="stylesheet" href="../css/attendance.css" />
    <style>
      /* Blur background when modal is open */
      body.modal-open .container {
        filter: blur(5px);
        pointer-events: none;
      }

      /* Modal styles */
      #clockModalContainer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
      }

      #clockModalContainer.show {
        display: flex;
      }

      #clockModalContainer iframe {
        width: 100%;
        max-width: 550px;
        height: 1000px;
        border: none;
        border-radius: 20px;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
        background: white;
      }

      @media (max-width: 1000px) {
        #clockModalContainer {
          padding: 20px 15px;
        }

        #clockModalContainer iframe {
          max-width: 100%;
          height: 100%;
          border-radius: 15px;
        }
      }

      @media (max-width: 480px) {
        #clockModalContainer {
          padding: 10px;
        }

        #clockModalContainer iframe {
          height: 750px;
          border-radius: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo-box">
            <img src="../images/rmt2.png" alt="RMT Logo" class="sidebar-logo">
            <div class="company-info">
              <h2 class="logo">RMT MARKETING</h2>
              <p class="company-subtitle">Human Resource Management</p>
            </div>
          </div>
          <div class="company-details">
            <p class="detail-item">SmartStock Medical Supply Trading</p>
            <p class="detail-item">1234 MedTech Avenue, Quezon City, Philippines</p>
            <p class="detail-item">üìû (02) 8888-1234 | ‚úâÔ∏è smartstock.ph@gmail.com</p>
            <p class="detail-item">VAT Reg. TIN: 123-456-789-000</p>
            <p class="detail-item">NON-VAT Registered</p>
          </div>
        </div>

        <p id="welcomeText" style="font-weight:500; color:#16a34a;"></p>

        <nav class="nav" id="sidebarNav">
          <a href="dashboard.html" class="nav-item" id="navDashboard">üè† Dashboard</a>
          <a href="employee.html" class="nav-item" id="navEmployees">üë• Employees</a>
          <a href="attendance.html" class="nav-item" id="navAttendance">üïí Attendance</a>
          <a href="leave.html" class="nav-item" id="navLeave">üìÑ Leave Management</a>
          <a href="leaverequest.html" class="nav-item" id="navLeaveRequest">üìÑ Leave Request</a>   
          <a href="payroll.html" class="nav-item" id="navPayroll">üí≤ Payroll</a>
          <a href="reports.html" class="nav-item" id="navReports">üìä Reports</a>
        </nav>

        <div class="user-menu-sidebar">
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Icon" class="user-icon" id="userIcon">
          <div class="dropdown-menu" id="dropdownMenu">
            <p id="userEmailDisplay"></p>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main">
        <header>
          <h1>Attendance Tracking</h1>
          <p>Monitor employee time and attendance</p>
        </header>

        <section class="controls">
          <div>
            <label for="attendanceDate">DATE:</label>
            <input type="date" id="attendanceDate" />
          </div>

          <h3 id="totalAttendance">Total Attendance: 0</h3>

          <div>
            <button class="btn-green" id="logAttendanceBtn">+ Log Attendance</button>
          </div>
        </section>

        <div class="search-box">
          <input type="text" id="search" placeholder="Search Employees..." />
        </div>

        <table>
          <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Position</th>
                <th>Date</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Total Hours</th>
                <th>Action</th>
            </tr>
          </thead>

          <tbody id="attendanceTable"></tbody>
        </table>
      </main>
    </div>

    <!-- Modal Container for Clock In/Out -->
    <div id="clockModalContainer">
      <iframe id="clockIframe" src="in&out.html"></iframe>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const sidebar = document.querySelector(".sidebar");
        const welcomeText = document.getElementById('welcomeText');
        
        const loggedInUserString = localStorage.getItem('loggedInUser');
        let loggedInUser = null; 
        let userRole = 'HR';
        let userPosition = '';
        let userName = 'Guest';

        if (loggedInUserString) {
            loggedInUser = JSON.parse(loggedInUserString);
            userRole = loggedInUser.role;
            userPosition = loggedInUser.position || '';
            
            if (loggedInUser.first_name && loggedInUser.last_name) {
                userName = `${loggedInUser.first_name} ${loggedInUser.last_name}`;
            } else if (loggedInUser.employee_id) {
                userName = loggedInUser.employee_id;
            } else {
                userName = loggedInUser.email || 'User';
            }
        }

        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        if (welcomeText) {
            welcomeText.textContent = `Welcome, ${userName}.`;
        }

        if (userRole === "Employee" || isRestricted) {
            const navLinksToHide = [
                'navDashboard', 'navEmployees', 'navLeaveRequest', 
                'navPayroll', 'navReports'
            ];

            navLinksToHide.forEach(id => {
                const link = document.getElementById(id);
                if (link) {
                    link.style.display = 'none';
                }
            });
        }
        
        if (!document.querySelector(".hamburger-btn")) {
             const hamburger = document.createElement("button");
             hamburger.className = "hamburger-btn";
             hamburger.innerHTML = '<span></span><span></span><span></span>';
             sidebar.appendChild(hamburger);
        }

        const hamburger = document.querySelector(".hamburger-btn");
        let isExpanded = false;
        let hoverTimeout;

        hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            isExpanded = !isExpanded;
            sidebar.classList.toggle("expanded", isExpanded);
        });

        sidebar.addEventListener("mouseenter", () => {
            clearTimeout(hoverTimeout);
            sidebar.classList.add("expanded");
        });

        sidebar.addEventListener("mouseleave", () => {
            if (!isExpanded) {
                hoverTimeout = setTimeout(() => {
                    sidebar.classList.remove("expanded");
                }, 300);
            }
        });
        
        const navItems = document.querySelectorAll(".nav-item");
        const currentPage = window.location.pathname.split("/").pop();
        
        navItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active");
            }
            
            const text = item.textContent.trim();
            const icon = text.split(" ")[0];
            const label = text.substring(icon.length).trim();
            item.innerHTML = `<span class="nav-item-icon">${icon}</span><span class="nav-item-text">${label}</span>`;
        });

        const userIcon = document.getElementById("userIcon");
        const dropdownMenu = document.getElementById("dropdownMenu");
        const logoutBtn = document.getElementById("logoutBtn");
        const userEmailDisplay = document.getElementById("userEmailDisplay");

        if (userEmailDisplay && loggedInUser) {
            userEmailDisplay.textContent = loggedInUser.email || 'N/A';
        }

        userIcon?.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".user-menu-sidebar")) {
                dropdownMenu.classList.remove("show");
            }
        });

        logoutBtn?.addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "index.html";
        });

        // === MODAL FUNCTIONALITY ===
        const logAttendanceBtn = document.getElementById("logAttendanceBtn");
        const clockModalContainer = document.getElementById("clockModalContainer");
        const clockIframe = document.getElementById("clockIframe");

        if (logAttendanceBtn) {
            logAttendanceBtn.addEventListener("click", () => {
                // Show modal and blur background
                clockModalContainer.classList.add("show");
                document.body.classList.add("modal-open");
                
                // Reload iframe to refresh the clock page
                clockIframe.src = clockIframe.src;
            });
        }

        // Close modal when clicking outside iframe
        clockModalContainer?.addEventListener("click", (e) => {
            if (e.target === clockModalContainer) {
                clockModalContainer.classList.remove("show");
                document.body.classList.remove("modal-open");
            }
        });

        // Listen for messages from iframe (for close button inside in&out.html)
        window.addEventListener("message", (event) => {
            if (event.data === "closeModal") {
                clockModalContainer.classList.remove("show");
                document.body.classList.remove("modal-open");
            }
        });
    });
    
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/attendance.js"></script>
    
  </body>
</html>