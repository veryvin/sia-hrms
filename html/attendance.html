<!DOCTYPE html>
<html lang="en">
  <script>
    // ===================================================
    // ENHANCED ACCESS CONTROL FOR RESTRICTED POSITIONS
    // ===================================================
    const hrOnlyPages = [
        "dashboard.html", "employee.html", "employee_add.html", 
        "employee_edit.html", "employee_view.html", "payroll.html", "reports.html", 
        "leaverequest.html", "in&out.html"
    ];

    const currentPage = window.location.pathname.split("/").pop();
    const loggedInUserString = localStorage.getItem('loggedInUser');

    if (!loggedInUserString) {
        window.location.href = "index.html";
    } else {
        const loggedInUser = JSON.parse(loggedInUserString);
        const userRole = loggedInUser.role;
        const userPosition = loggedInUser.position || '';
        
        // Define restricted positions
        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        console.log('ğŸ” Access Control Check:');
        console.log('   - Role:', userRole);
        console.log('   - Position:', userPosition);
        console.log('   - Is Restricted:', isRestricted);
        console.log('   - Current Page:', currentPage);

        // Redirect restricted users trying to access HR-only pages
        if (isRestricted && hrOnlyPages.includes(currentPage)) {
            console.log('ğŸš« Restricted user attempting to access HR page. Redirecting...');
            window.location.href = "attendance.html";
        }
        
        // Also handle Employee role separately
        if (userRole === "Employee" && hrOnlyPages.includes(currentPage)) {
            console.log('ğŸš« Employee role attempting to access HR page. Redirecting...');
            window.location.href = "attendance.html";
        }
    }
  </script>

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Tracking</title>
    <link rel="stylesheet" href="../css/attendance.css" />
  </head>
  <body>
    <div class="container">
      <!-- Animated Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo-box">
            <img src="../images/rmt2.png" alt="RMT Logo" class="sidebar-logo">
            <div class="company-info">
              <h2 class="logo">RMT MARKETING</h2>
              <p class="company-subtitle">Human Resource Management</p>
            </div>
          </div>
          <div class="company-details">
            <p class="detail-item">SmartStock Medical Supply Trading</p>
            <p class="detail-item">1234 MedTech Avenue, Quezon City, Philippines</p>
            <p class="detail-item">ğŸ“ (02) 8888-1234 | âœ‰ï¸ smartstock.ph@gmail.com</p>
            <p class="detail-item">VAT Reg. TIN: 123-456-789-000</p>
            <p class="detail-item">NON-VAT Registered</p>
          </div>
        </div>

        <p id="welcomeText" style="font-weight:500; color:#16a34a;"></p>

        <nav class="nav" id="sidebarNav">
          <a href="dashboard.html" class="nav-item" id="navDashboard">ğŸ  Dashboard</a>
          <a href="employee.html" class="nav-item" id="navEmployees">ğŸ‘¥ Employees</a>
          <a href="attendance.html" class="nav-item" id="navAttendance">ğŸ•’ Attendance</a>
          <a href="leave.html" class="nav-item" id="navLeave">ğŸ“„ Leave Management</a>
          <a href="leaverequest.html" class="nav-item" id="navLeaveRequest">ğŸ“„ Leave Request</a>   
          <a href="payroll.html" class="nav-item" id="navPayroll">ğŸ’² Payroll</a>
          <a href="reports.html" class="nav-item" id="navReports">ğŸ“Š Reports</a>
        </nav>

        <div class="user-menu-sidebar">
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Icon" class="user-icon" id="userIcon">
          <div class="dropdown-menu" id="dropdownMenu">
            <p id="userEmailDisplay"></p>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main">
        <header>
          <h1>Attendance Tracking</h1>
          <p>Monitor employee time and attendance</p>
        </header>

        <section class="controls">
          <div>
            <label for="attendanceDate">DATE:</label>
            <input type="date" id="attendanceDate" />
          </div>

          <h3 id="totalAttendance">Total Attendance: 0</h3>

          <div>
            <button class="btn-green" id="logAttendanceBtn">+ Log Attendance</button>
          </div>
        </section>

        <div class="search-box">
          <input type="text" id="search" placeholder="Search Employees..." />
        </div>

        <table>
          <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Position</th>
                <th>Date</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Total Hours</th>
                <th>Action</th>
            </tr>
          </thead>

          <tbody id="attendanceTable"></tbody>
        </table>
      </main>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const sidebar = document.querySelector(".sidebar");
        const welcomeText = document.getElementById('welcomeText');
        
        // --- User Data Initialization ---
        const loggedInUserString = localStorage.getItem('loggedInUser');
        let loggedInUser = null; 
        let userRole = 'HR';
        let userPosition = '';
        let userName = 'Guest';

        if (loggedInUserString) {
            loggedInUser = JSON.parse(loggedInUserString);
            userRole = loggedInUser.role;
            userPosition = loggedInUser.position || '';
            
            if (loggedInUser.first_name && loggedInUser.last_name) {
                userName = `${loggedInUser.first_name} ${loggedInUser.last_name}`;
            } else if (loggedInUser.employee_id) {
                userName = loggedInUser.employee_id;
            } else {
                userName = loggedInUser.email || 'User';
            }
        }

        // Check if user has restricted access
        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        // 1. Set Welcome Text
        if (welcomeText) {
            welcomeText.textContent = `Welcome, ${userName}.`;
        }

        // 2. Sidebar Hiding Logic (for restricted users)
        if (userRole === "Employee" || isRestricted) {
            const navLinksToHide = [
                'navDashboard', 'navEmployees', 'navLeaveRequest', 
                'navPayroll', 'navReports'
            ];

            navLinksToHide.forEach(id => {
                const link = document.getElementById(id);
                if (link) {
                    link.style.display = 'none';
                }
            });
        }
        
        // 3. --- Sidebar Animation Logic ---
        if (!document.querySelector(".hamburger-btn")) {
             const hamburger = document.createElement("button");
             hamburger.className = "hamburger-btn";
             hamburger.innerHTML = '<span></span><span></span><span></span>';
             sidebar.appendChild(hamburger);
        }

        const hamburger = document.querySelector(".hamburger-btn");
        let isExpanded = false;
        let hoverTimeout;

        hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            isExpanded = !isExpanded;
            sidebar.classList.toggle("expanded", isExpanded);
        });

        sidebar.addEventListener("mouseenter", () => {
            clearTimeout(hoverTimeout);
            sidebar.classList.add("expanded");
        });

        sidebar.addEventListener("mouseleave", () => {
            if (!isExpanded) {
                hoverTimeout = setTimeout(() => {
                    sidebar.classList.remove("expanded");
                }, 300);
            }
        });
        
        // 4. Set Active Link and Format Nav Items
        const navItems = document.querySelectorAll(".nav-item");
        const currentPage = window.location.pathname.split("/").pop();
        
        navItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active");
            }
            
            const text = item.textContent.trim();
            const icon = text.split(" ")[0];
            const label = text.substring(icon.length).trim();
            item.innerHTML = `<span class="nav-item-icon">${icon}</span><span class="nav-item-text">${label}</span>`;
        });

        // 5. --- User Dropdown Menu Logic ---
        const userIcon = document.getElementById("userIcon");
        const dropdownMenu = document.getElementById("dropdownMenu");
        const logoutBtn = document.getElementById("logoutBtn");
        const userEmailDisplay = document.getElementById("userEmailDisplay");

        if (userEmailDisplay && loggedInUser) {
            userEmailDisplay.textContent = loggedInUser.email || 'N/A';
        }

        userIcon?.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".user-menu-sidebar")) {
                dropdownMenu.classList.remove("show");
            }
        });

        logoutBtn?.addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "index.html";
        });
    });
</script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/attendance.js"></script>
    
  </body>
</html>