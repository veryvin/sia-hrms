<!DOCTYPE html>
<html lang="en">
<script>
    // ===================================================
    // ENHANCED ACCESS CONTROL FOR RESTRICTED POSITIONS
    // ===================================================
    const hrOnlyPages = [
        "dashboard.html", 
        "employee.html", 
        "employee_add.html",
        "employee_edit.html", 
        "employee_view.html", 
        "payroll.html", 
        "reports.html", 
        "leaverequest.html",
        "in&out.html"
    ];

    const currentPage = window.location.pathname.split("/").pop();
    const loggedInUserString = localStorage.getItem('loggedInUser');

    if (!loggedInUserString) {
        window.location.href = "index.html";
    } else {
        const loggedInUser = JSON.parse(loggedInUserString);
        const userRole = loggedInUser.role;
        const userPosition = loggedInUser.position || '';
        
        // Define restricted positions
        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        console.log('üîç Access Control Check:');
        console.log('   - Role:', userRole);
        console.log('   - Position:', userPosition);
        console.log('   - Is Restricted:', isRestricted);

        // 1. If restricted user tries to access a restricted HR page, redirect to leave.html
        if (isRestricted && hrOnlyPages.includes(currentPage)) {
            window.location.href = "leave.html"; 
        }
        
        // 2. If Employee role tries to access restricted pages
        if (userRole === "Employee" && hrOnlyPages.includes(currentPage)) {
            window.location.href = "leave.html"; 
        }
        
        // 3. Ensure restricted users only access leave.html or attendance.html
        if ((isRestricted || userRole === "Employee") && 
            currentPage !== "leave.html" && 
            currentPage !== "attendance.html") {
            window.location.href = "leave.html"; 
        }
    }
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leave Balances - RMT HRMS</title>
  <link rel="stylesheet" href="../css/leave.css" />
</head>
<body>
  <div class="container">
    <!-- Animated Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="../images/rmt2.png" alt="RMT Logo" class="sidebar-logo">
          <div class="company-info">
            <h2 class="logo">RMT MARKETING</h2>
            <p class="company-subtitle">Human Resource Management</p>
          </div>
        </div>
        <div class="company-details">
          <p class="detail-item">SmartStock Medical Supply Trading</p>
          <p class="detail-item">1234 MedTech Avenue, Quezon City, Philippines</p>
          <p class="detail-item">üìû (02) 8888-1234 | ‚úâÔ∏è smartstock.ph@gmail.com</p>
          <p class="detail-item">VAT Reg. TIN: 123-456-789-000</p>
          <p class="detail-item">NON-VAT Registered</p>
        </div>
      </div>

      <p id="welcomeText" style="font-weight:500; color:#16a34a;"></p>

      <nav class="nav" id="sidebarNav">
        <a href="dashboard.html" class="nav-item" id="navDashboard">üè† Dashboard</a>
        <a href="employee.html" class="nav-item" id="navEmployees">üë• Employees</a>
        <a href="attendance.html" class="nav-item" id="navAttendance">üïí Attendance</a>
        <a href="leave.html" class="nav-item" id="navLeave">üìÑ Leave Management</a>
        <a href="leaverequest.html" class="nav-item" id="navLeaveRequest">üìÑ Leave Request</a>
        <a href="payroll.html" class="nav-item" id="navPayroll">üí≤ Payroll</a>
        <a href="reports.html" class="nav-item" id="navReports">üìä Reports</a>
      </nav>

      <div class="user-menu-sidebar">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Icon" class="user-icon" id="userIcon">
        <div class="dropdown-menu" id="dropdownMenu">
          <p id="userEmailDisplay"></p>
          <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <header class="leave-header">
        <div>
          <h1>Leave Balances</h1>
          <p>View employee leave balances and submit leave requests</p>
        </div>
      </header>

      <div class="tabs">
        <button class="tab active" data-tab="balances">Leave Balances</button>
        <button class="tab" data-tab="pending">Pending</button>
        <button class="tab" data-tab="approved">Approved</button>
        <button class="tab" data-tab="rejected">Rejected</button>
      </div>

      <section class="leave-list" id="leaveList">
        <p class="no-leave">No leave requests or balances found</p>
      </section>
    </main>
  </div>

  <!-- Leave Request Modal -->
  <div id="leaveModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h3>New Leave Request</h3>

      <form id="leaveForm">
        <label for="employeeId">Employee ID</label>
        <input type="text" id="employeeId" placeholder="Enter employee ID" required>

        <label for="employeeName">Employee Name</label>
        <input type="text" id="employeeName" placeholder="Enter employee name" required>

        <label for="department">Department</label>
        <input type="text" id="department" placeholder="Enter department" required>

        <label for="position">Position</label>
        <input type="text" id="position" placeholder="Enter position" required>

        <label>Remaining Leave Balance</label>
        <p id="remainingBalance" class="static-balance" style="
            padding: 8px;
            background: #f3f4f6;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-weight: 600;
        "></p>

        <label for="leaveType">Leave Type</label>
        <select id="leaveType" required>
          <option value="Vacation">Vacation</option>
          <option value="Sick">Sick</option>
          <option value="Bereavement">Bereavement</option>
          <option value="Maternity/Paternity">Maternity/Paternity</option>
          <option value="Other">Other</option>
        </select>

        <div class="date-row">
          <div>
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" required>
          </div>
          <div>
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" required>
          </div>
        </div>

        <label for="reason">Reason</label>
        <textarea id="reason" rows="3" placeholder="Enter reason"></textarea>

        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-submit">Submit Request</button>
        </div>
      </form>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
<script src="../js/supabase-config.js"></script> 
<script src="../js/leave.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const sidebar = document.querySelector(".sidebar");
        const welcomeText = document.getElementById('welcomeText');
        
        // --- User Data Initialization ---
        const loggedInUserString = localStorage.getItem('loggedInUser');
        let loggedInUser = null; 
        let userRole = 'HR';
        let userPosition = '';
        let userName = 'Guest';

        if (loggedInUserString) {
            loggedInUser = JSON.parse(loggedInUserString);
            userRole = loggedInUser.role;
            userPosition = loggedInUser.position || '';
            
            if (loggedInUser.first_name && loggedInUser.last_name) {
                userName = `${loggedInUser.first_name} ${loggedInUser.last_name}`;
            } else if (loggedInUser.employee_id) {
                userName = loggedInUser.employee_id;
            } else {
                userName = loggedInUser.email || 'User';
            }
        }

        // Check if user has restricted access
        const restrictedPositions = ['Employee', 'Driver', 'Dispatcher', 'employee', 'driver', 'dispatcher'];
        const isRestricted = restrictedPositions.some(p => p.toLowerCase() === userPosition.toLowerCase());

        // 1. Set Welcome Text
        if (welcomeText) {
            welcomeText.textContent = `Welcome, ${userName}.`;
        }

        // 2. Sidebar Hiding Logic (for restricted users)
        if (userRole === "Employee" || isRestricted) {
            const navLinksToHide = [
                'navDashboard', 'navEmployees', 'navLeaveRequest', 
                'navPayroll', 'navReports'
            ];

            navLinksToHide.forEach(id => {
                const link = document.getElementById(id);
                if (link) {
                    link.style.display = 'none';
                }
            });
        }
        
        // 3. --- Sidebar Animation Logic ---
        if (!document.querySelector(".hamburger-btn")) {
             const hamburger = document.createElement("button");
             hamburger.className = "hamburger-btn";
             hamburger.innerHTML = '<span></span><span></span><span></span>';
             sidebar.appendChild(hamburger);
        }

        const hamburger = document.querySelector(".hamburger-btn");
        let isExpanded = false;
        let hoverTimeout;

        hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            isExpanded = !isExpanded;
            sidebar.classList.toggle("expanded", isExpanded);
        });

        sidebar.addEventListener("mouseenter", () => {
            clearTimeout(hoverTimeout);
            sidebar.classList.add("expanded");
        });

        sidebar.addEventListener("mouseleave", () => {
            if (!isExpanded) {
                hoverTimeout = setTimeout(() => {
                    sidebar.classList.remove("expanded");
                }, 300);
            }
        });
        
        // 4. Set Active Link and Format Nav Items
        const navItems = document.querySelectorAll(".nav-item");
        const currentPage = window.location.pathname.split("/").pop();
        
        navItems.forEach(item => {
            if (item.getAttribute("href") === currentPage) {
                item.classList.add("active");
            }
            
            const text = item.textContent.trim();
            const icon = text.split(" ")[0];
            const label = text.substring(icon.length).trim();
            item.innerHTML = `<span class="nav-item-icon">${icon}</span><span class="nav-item-text">${label}</span>`;
        });

        // 5. --- User Dropdown Menu Logic ---
        const userIcon = document.getElementById("userIcon");
        const dropdownMenu = document.getElementById("dropdownMenu");
        const logoutBtn = document.getElementById("logoutBtn");
        const userEmailDisplay = document.getElementById("userEmailDisplay");

        if (userEmailDisplay && loggedInUser) {
            userEmailDisplay.textContent = loggedInUser.email || 'N/A';
        }

        userIcon?.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".user-menu-sidebar")) {
                dropdownMenu.classList.remove("show");
            }
        });

        logoutBtn?.addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "index.html";
        });
    });
</script>
</body>
</html>